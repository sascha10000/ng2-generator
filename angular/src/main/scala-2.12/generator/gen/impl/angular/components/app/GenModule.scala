package generator.gen.impl.angular.components.app

import basic.{FileOps, Ops}
import generator.gen.GenFile
import generator.gen.impl.angular.Ng2Vars
import generator.gen.impl.angular.components.component.GenComponentClass
import generator.gen.template.BasicTemplate
import generator.gen.template.manipulators.StringReplacer

/**
  * Created by Sascha on 12.02.2017.
  */
class GenModule(ngRoot:String, val imports:List[(Option[String], Option[GenComponentClass])]) extends GenFile {
  import generator.gen.impl.angular.components._

  val basePath = ngRoot + "/" + Ng2Vars.appSrcPath
  val templatePath = "generator/gen/impl/angular/components/app/Module.tmpl"
  val template = BasicTemplate.fromFile(templatePath) << StringReplacer("file_imports", genFileImports) << StringReplacer("imports", genImports) << StringReplacer("RoutePaths", genRoutes)

  override def path(): Option[String] = None
  override def filename(): String = "app.module.ts"
  override def content(): String = template.template

  // Deletes the Module file generated by "ng generate <project_name>" and recreates it
  Ops.print{ FileOps.deleteFile(basePath + "/"+ filename()) }
  Ops.print { FileOps.createFileWithContent(basePath + "/" + filename, content) }

  def genImports = imports.foldLeft("")((prev, elem) => {
    prev + {
      if (elem._2.isDefined)
        ",\n\t\t" + elem._2.get.compName + "Component"
      else
        ""
    }
  })

  def genFileImports = imports.foldLeft("")((prev, elem) => {
    prev + {
      if(elem._2.isDefined) extract(elem._2.get) { (el) => {
          "\nimport { " + el.compName + "Component } from './" + el.path().get + "/" + el.compNameWeb + ".component';"
      }}
      else ""
    }
  })

  // TODO: Use the Route by changing the constructors parameter import to the type List[(Option[Route], Option[GenComponentClass])]
  def genRoutes = imports.foldLeft("")((prev, elem) => {
    if(prev == "")
      if(elem._2.isDefined){
          "{ path : \"" + extractRoute(elem) + "\", component: " + elem._2.get.compName + "Component }"
      } else ""
    else
      prev + {
        if(elem._2.isDefined)  {
          ",{ path : \"" + extractRoute(elem) + "\", component: " + elem._2.get.compName + "Component }"
        } else ""
      }
  })
}
